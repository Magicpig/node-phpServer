<!DOCTYPE html>
<html style="overflow: hidden">
<title>Artron WebServer beta</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
<script src="http://cdn.bootcss.com/jquery/1.10.2/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/js/bootstrap.min.js"></script>
<body style="overflow: hidden">
<script type="text/javascript">
    String.prototype.replaceAll = function (reallyDo, replaceWith, ignoreCase) {
        if (!RegExp.prototype.isPrototypeOf(reallyDo)) {
            return this.replace(new RegExp(reallyDo, (ignoreCase ? "gi" : "g")), replaceWith);
        } else {
            return this.replace(reallyDo, replaceWith);
        }
    }
    var _=require('underscore');
    var fs = require('fs');
    var gui = require('nw.gui');//or global.window.nwDispatcher.requireNwGui() (see https://github.com/rogerwang/node-webkit/issues/707)
    // Get the current window
    var win = gui.Window.get();
//    gui.Shell.openExternal('https://github.com/rogerwang/node-webkit');
//    gui.Shell.openItem('');
    var  child_process = require('child_process');
    spawn = require('child_process').spawn;
    var path = require('path');
    var main = {
        _logs : new Array(),
        Path: process.cwd(),
        _status: false,
        _server: null,
        StartServer: function () {
            if (main._status == false) {
                path.resolve(main.Path);
                var phpServer = spawn('sudo', ['/usr/local/bin/node','phpServer.js']);
                phpServer.stdout.on('data', function (data) {
                    var messages = data.toString();
                    var messages = messages.replaceAll(' ', "&nbsp;");
                    main.LogMessage(messages.toString());
                });

                phpServer.stderr.on('data', function (data) {
                    main.LogMessage('启动web服务器出错了<br>' + data.toString());
                });
                main._server = phpServer;
                return;
            }
            main.LogMessage('服务器已经启动，无法再启动');
        },
        RestartServer: function () {
            main.StopServer();
            main.StartServer();
        },
        ClearLogs:function(){
            main._logs = new Array();
            main.DisplayLog();
        },
        /**
         * 杀掉服务进程
         * @constructor
         */
        StopServer: function () {
            spawn('sudo',['killall','node_ArtronNodeWebMaster']);
            spawn('sudo',['killall','node_ArtronNodeWebWorker']);
            main.LogMessage('服务已经停止');
//            if (main._server != null) {
//                main._server.kill('SIGHUP');
//                main.LogMessage('服务已经停止');
//                main._status = false;
//            }
        },
        LogMessage: function (messages) {
            main._logs.push(messages);
            if (main._logs.length>500){
                main._logs.shift();
            }
            main.DisplayLog();

        },
        DisplayLog:function(){
            var html ='';
            for(var i = main._logs.length-1; i>0;i-- ){

                html = html + main._logs[i]+'<br>';
            }
            document.getElementById('message').innerHTML = html;
        }
    }
    var _sudo = spawn('sudo', ['su','-']);
    win.on('close', function() {
        this.hide(); // Pretend to be closed already
        main.StopServer();
        this.close(true);
    });
    window.onload=function(){
        var vhostFiles = fs.readdirSync('vhost/');
        if (vhostFiles && vhostFiles.length > 0) {
            for (var i = 0; i < vhostFiles.length; i++) {
                var vhostEditButton = document.createElement('button');
                vhostEditButton.className ='btn btn-success';
                if (i>0){
                    vhostEditButton.style.marginLeft = '10px';
                }
                vhostEditButton.innerHTML='编辑'+vhostFiles[i];
                (function(i){
                    vhostEditButton.onclick =function(){
//                        alert(process.cwd()+'/'+vhostFiles[i]);
                 //alert(vhostFiles[i]);
                       gui.Shell.showItemInFolder(process.cwd()+'/vhost/'+vhostFiles[i]);
                    }
                })(i);


                document.getElementById('vhosts').appendChild(vhostEditButton);
            }
        }
    }
</script>
<div class="row"
     style=" margin: 0px;  padding-top:10px;overflow:hidden;height:600px;width:800px;font:12px;color:#000000;">
    <div class="col-md-12" style="font-color:#ffffff">
        <!-- Single button -->
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                服务管理 <span class="caret"></span>
            </button>

            <ul class="dropdown-menu" role="menu">
                <li><a href="javascript:main.StartServer();">启动web服务器</a></li>
                <!--<li><a href="javascript:main.RestartServer();">重启web服务器</a></li>-->
                <li><a href="javascript:main.StopServer();">停止web服务器</a></li>
            </ul>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                日志管理 <span class="caret"></span>
            </button>

            <ul class="dropdown-menu" role="menu">
                <li><a href="javascript:main.ClearLogs();">清除Logs</a></li>
            </ul>
        </div>

    </div>
    <div class="col-md-12" id="vhosts" style="margin-top: 20px;"></div>
    <h2>&nbsp;&nbsp;Info</h2>

    <div id="message" style="overflow:scroll;  height: 440px; padding-left: 10px; font-size: 10px;"></div>

</div>
</body>
</html>